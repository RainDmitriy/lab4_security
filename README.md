# Проект News Service

## **1. Описание**

Приложение предоставляет функционал работы с новостями: регистрация пользователей, аутентификация, создание, редактирование и просмотр новостей через REST API.

---

## **2. Структура проекта**

```
project_root/
├─ backend/                 # Backend на FastAPI
│  ├─ alembic/              # Миграции БД
│  ├─ auth/                 # Модули аутентификации
│  ├─ controllers/          # Контроллеры API
│  ├─ models/               # ORM-модели
│  ├─ repositories/         # Репозитории БД
│  ├─ schemas/              # Pydantic-схемы
│  ├─ services/             # Сервисы бизнес-логики
│  ├─ utils/                # Утилиты (например, для хеширования паролей)
│  ├─ main.py               # Точка входа
│  └─ .env                  # Переменные окружения backend
├─ frontend/                # Frontend на Vite + React
│  ├─ src/
│  │  ├─ components/        # UI-компоненты
│  │  ├─ pages/             # Страницы приложения
│  │  ├─ contexts/          # React Context
│  │  ├─ store/             # Zustand store
│  │  └─ api/               # HTTP клиент
│  └─ .env                  # Переменные окружения frontend
├─ tests/                   # Тесты backend
├─ docker-compose.yml
└─ .env                     # env для Compose
```

---

## **3. Environment variables**

### **Корневой `.env` (для Docker Compose)**

```env
DB_USER=<db_user>
DB_PASSWORD=<db_password>
DB_NAME=<db_name>
```

### **frontend/.env**

```env
VITE_API_URL=http://localhost:8000
```

### **backend/.env**

```env
DATABASE_URL="postgresql+asyncpg://<db_user>:<db_password>@<db_host>:<db_port>/<db_name>"
REDIS_URL="redis://<redis_host>:<redis_port>"
GITHUB_CLIENT_ID=<github_client_id>
GITHUB_CLIENT_SECRET=<github_client_secret>
SECRET_KEY=<secret_key>
REFRESH_SECRET_KEY=<refresh_secret_key>
BACKEND_CORS_ORIGINS=["http://localhost:5173", "http://localhost:8000", "http://<your-ip>:5173"]
```

---

## **4. Шаги запуска**

1. Клонировать репозиторий:

```bash
git clone https://github.com/RainDmitriy/lab4_security
cd lab4_security
```

2. Создать `.env` в `./`, `./frontend`, `backend`:

3. Поднять сервисы через Docker Compose:

```bash
docker compose up -d --build
```

4. Веб-интерфейс доступен по адресу `http://localhost:5173`.

---

## **5. curl-примеры** (`http://localhost:8000/docs`)

---

## **6. Безопасность: что сделано**

1. **Аутентификация и авторизация**

   * Используются **JWT токены**:

     * **Access Token**: короткоживущий, передаётся в заголовке `Authorization: Bearer <token>` для всех защищённых запросов.
     * **Refresh Token**: долгоживущий, хранится в **HttpOnly cookie** и используется только для обновления access_token.
   * **Роли пользователей**:

     * `user` — обычный пользователь.
     * `admin` — администратор.
   * Права ограничены:

     * Создание/редактирование/удаление новостей и комментариев доступно только автору или администратору.
     * Невозможно создать пользователя с привилегиями администратора через API. Минимальные права устанавливаются по умолчанию. Изменение прав — только через БД (в будущем можно добавить интерфейс для АИБа).
   * **ID пользователя** берутся только из JWT токена, а не из тела запросов. Это исключает возможность подмены идентификатора при действиях на чужие ресурсы.

2. **Регистрация и логин**

   * Пользователь регистрируется отдельно через `/auth/register` (email + пароль).
   * Пароль **не хранится в открытом виде**.
   * После регистрации пользователь получает минимальные права (`user`, `is_author_verified=False`).

3. **Пароли**

   * Хранятся только в виде **хэшированного значения** (Argon2) в базе данных.
   * Для OAuth пользователей пароль не требуется и не хранится, чтобы исключить риск утечки.

4. **OAuth (GitHub)**

   * Вход через GitHub OAuth вместо стандартного логина.
   * После успешного входа выдаются access/refresh токены.
   * Интеграция с ролевой моделью (`user`, `admin`) и флагом `is_author_verified`.
   * **HttpOnly cookie** для refresh токена предотвращает XSS-атаки на токены.
   * CSRF-атаки предотвращаются коротким сроком жизни access_token и проверкой токена при каждом запросе.

5. **Кэширование и хранение сессий**

   * Кэширование данных пользователей и новостей через **Redis**.
   * Сессии пользователя (refresh-токены) также хранятся в Redis.
   * Возможность принудительно заблокировать токен (например, при выходе или подозрительной активности).

6. **Безопасность API**

   * Все защищённые ручки требуют валидного **access_token**.
   * Пользователь не может изменять чужие данные: проверка прав встроена через зависимости FastAPI, а не в контроллерах.
   * CRUD операции на пользователях ограничены для обычных пользователей; только админ может создавать новых пользователей с минимальными правами.
   * Все операции с id пользователей берутся из токена, что исключает возможность подмены чужого id.

7. **Шифрование и передача данных**

   * Предполагается использование HTTPS для защиты данных при передаче.
   * Пароли и токены никогда не передаются в URL, только в теле запроса или заголовках.

8. **JWT и refresh**

   * При обновлении refresh_token старый refresh токен **деактивируется**, выдаётся новая пара токенов.
   * Это предотвращает повторное использование старых токенов.

9. **Каскадное удаление**

   * При удалении новости автоматически удаляются все связанные комментарии. Это исключает «висячие» объекты, которые могут содержать чувствительную информацию.

10. **Сессии и контроль активности**

    * Пользователь может просматривать активные сессии (`/auth/sessions`) и при необходимости разлогиниваться на всех устройствах.
    * При refresh или logout старые токены становятся недействительными.

11. **Валидация и проверка данных**

    * Входящие данные проверяются на корректность (например, логин, пароль, структура JSON, обязательные поля).
    * Для OAuth пользователей устанавливаются только допустимые поля (`login`, `avatar_url`, `role`, `is_author_verified`), исключая возможность подмены прав.

